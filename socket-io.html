<link rel="import" href="../polymer/polymer.html">
<script src="../socket.io-client/dist/socket.io.min.js"></script>
<!--<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>-->

<!--
`socket-io`
Polymer 1.0 element for socket.io apis

@demo demo/index.html
-->

<dom-module id="socket-io">
  <template>
  </template>

  <script>
    Polymer({

      is: 'socket-io',

      properties: {
        endpoint: {
          type: String,
          value: 'http://localhost:8080'
        },
        isConnected: {
          type: Boolean,
          value: null
        },
        loaded: {
          type: Function
        },
        /**
        * Array with child objects - two properties.
        * event (name of event to trigger on) and onEvent (a callback function).
        */
        events: {
          type: Array,
          value: [{ event: "onConnect", onEvent: function(data){
            console.log("connected");
          }}]
        }
      },
      ready: function(){
        console.log("Connection In Progress");
        if(this.loaded){
          this.loaded();
        }
      },

      /**
       * The emit method sends an event with 'payload' as content and allows optional compression
       *
       * @method emit
       * @param {String} event event to send
       * @param {Object} payload the json data to send
       * @param {Boolean} compres the event
       */
      emit: function(event, data, compress)
	    {
			  try
			  {
          if(this.socket) this.socket.compress(compress).emit(event, data);
			  }catch(error)
			  {
				  console.log("Failed to send message: "+error);
			  }
      },
      /**
       * Update the message within state
       *
       * @method message
       */
      _updateMessage: function(message){
        if(typeof message !== "object"){
          this.outMessage = {message: message};
        } else{
          this.outMessage = message;
        }
      },
      /**
       * The connect method triggers connection to the socket.io server
       *
       * @method connect
       */
	    connect: function()
	    {
        console.log('Connection in progress');
		    this.disconnect();
        this.socket = io.connect(this.endpoint);
        var ths = this;
        this.isConnected = true;
        this.events.forEach(function(event){
          ths.socket.on(event.event, event.onEvent);
        });
	    },
	    /**
       * The disconnect method triggers disconnection from the socket.io server
       *
       * @method disconnect
       */
	    disconnect:function()
	    {
		    if (this.socket != undefined && !this.isConnected)
		    {
          try{
            this.socket.disconnect();
            this.isConnected = false;
          }
          catch(error){
            this.onError(error);
          }
        }
	    },
      /**
       * Register extra events 
       *
       * @method registerEvents
       * @param {array} events - an array of events to registerEvents
       * @param {string} eventArr[].event - name of the event 
       * @param {function} eventArr[].onEvent - Function to be called when event is triggered
       */
      registerEvents: function(events)
      {
        var ths = this;
        events.forEach(function(event){
          const index = (ths.events.push(event) - 1);
          ths.socket.on(ths.events[index].event, ths.events[index].onEvent);
        });
      },
    });
  </script>
</dom-module>
